

<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title></title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;maxice8.github.io&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">maxice8-devel</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https://maxice8.github.io">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://maxice8.github.io&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;maxice8.github.io">maxice8-devel</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https://maxice8.github.io">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://maxice8.github.io&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://maxice8.github.io/void-cpython3-cross-pt1/#context" class="toc-link">Context</a>
                    
                </li>
                
                <li>
                    <a href="https://maxice8.github.io/void-cpython3-cross-pt1/#problem" class="toc-link">Problem</a>
                    
                </li>
                
                <li>
                    <a href="https://maxice8.github.io/void-cpython3-cross-pt1/#solving" class="toc-link">Solving</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;maxice8.github.io&#x2F;void-cpython3-cross-pt1&#x2F;">Fixing cross CPython3 modules in Void Linux, pt. 1</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-01-31</span>
            
        </div>
    </header>

    <div class="post-content">
      <h2 id="context">Context</h2>
<p>Last week i have been working on getting a particularly complex beast to be
cross-compilable under Void Linux's <a href="https://github.com/void-linux/void-packages">xbps-src</a>:
<a href="https://gi.readthedocs.io/en/latest/">GObject Introspection</a>.</p>
<p>While work was done on <code>xbps-src</code> cross compilation of CPython3 modules 2
problems were found.</p>
<p>The first problem was that modules cross-compiled used the ABI extension tag
in their .so files. i.g: <code>.cpython-36m-x86_64-linux-gnu.so</code> for x86_64.</p>
<p>That value is defined by the <a href="https://www.python.org/dev/peps/pep-3149/">PEP 3149</a>
and conveniently is available as the <code>EXT_SUFFIX</code> variable in the sysconfig module.</p>
<p>Examples for x86_64 and aarch64:</p>
<pre style="background-color:#383838;">
<span style="color:#e6e1dc;">$ python3
</span><span style="color:#cc7833;">&gt;&gt;&gt;</span><span style="color:#e6e1dc;"> import sysconfig
</span><span style="color:#cc7833;">&gt;&gt;&gt;</span><span style="color:#e6e1dc;"> sysconfig.get_config_var(</span><span style="color:#a5c261;">&#39;EXT_SUFFIX&#39;</span><span style="color:#e6e1dc;">)
</span><span style="color:#a5c261;">&#39;.cpython-36m-x86_64-linux-gnu.so&#39;
</span></pre><pre style="background-color:#383838;">
<span style="color:#e6e1dc;">$ python3
</span><span style="color:#cc7833;">&gt;&gt;&gt;</span><span style="color:#e6e1dc;"> import sysconfig
</span><span style="color:#cc7833;">&gt;&gt;&gt;</span><span style="color:#e6e1dc;"> sysconfig.get_config_var(</span><span style="color:#a5c261;">&#39;EXT_SUFFIX&#39;</span><span style="color:#e6e1dc;">)
</span><span style="color:#a5c261;">&#39;.cpython-36m-aarch64-linux-gnu.so&#39;
</span></pre><h2 id="problem">Problem</h2>
<p>The problem occurs when cross compiling, the <code>python3</code> used belongs to the build
system and not of the target system, consequently the <code>EXT_SUFFIX</code> used is the
build system one, not of the target one as it should be.</p>
<p>As a result, cross-compiling the <code>python-yaml</code> package with <code>xbps-src</code> will
produce the binaries with the wrong name, take the following example:</p>
<pre style="background-color:#383838;">
<span style="color:#e6e1dc;">$ xbps-src</span><span style="font-style:italic;color:#fd971f;"> -a</span><span style="color:#e6e1dc;"> aarch64 pkg python-yaml
</span><span style="color:#e6e1dc;">$ env XBPS_TARGET_ARCH=aarch64 xls python3-yaml </span><span style="color:#cc7833;">| </span><span style="color:#e6e1dc;">grep .cpython
</span><span style="color:#e6e1dc;">/usr/lib/python3.6/site-packages/_yaml.cpython-36m-x86_64-linux-gnu.so
</span></pre>
<p>See what's wrong ? A package compiled for <code>aarch64</code> (ARM 64bits) has the
prefix of <code>x86_64</code>! That's not right!</p>
<p>Let's push this further and actually try to load another package that has
the same problem on <code>aarch64</code>, <code>python-bluez</code>!</p>
<pre style="background-color:#383838;">
<span style="color:#e6e1dc;">$ python3
</span><span style="color:#cc7833;">&gt;&gt;&gt;</span><span style="color:#e6e1dc;"> import bluetooth
</span><span style="color:#e6e1dc;">Traceback (most recent call last)</span><span style="color:#da4939;">:
</span><span style="color:#e6e1dc;">  </span><span style="color:#e6e1dc;">File </span><span style="color:#c1be91;">&quot;&lt;stdin&gt;&quot;</span><span style="color:#e6e1dc;">, line 1, in </span><span style="color:#cc7833;">&lt;</span><span style="color:#e6e1dc;">module</span><span style="color:#cc7833;">&gt;
</span><span style="color:#e6e1dc;">  </span><span style="color:#e6e1dc;">File </span><span style="color:#c1be91;">&quot;/home/terran/usr/src/void-packages/masterdir/usr/aarch64-linux-gnu/usr/lib/python3.6/site-packages/bluetooth/__init__.py&quot;</span><span style="color:#e6e1dc;">, line 45, in </span><span style="color:#cc7833;">&lt;</span><span style="color:#e6e1dc;">module</span><span style="color:#cc7833;">&gt;
</span><span style="color:#e6e1dc;">    </span><span style="color:#e6e1dc;">from bluetooth.bluez import </span><span style="color:#cc7833;">*
</span><span style="color:#e6e1dc;">  </span><span style="color:#e6e1dc;">File </span><span style="color:#c1be91;">&quot;/home/terran/usr/src/void-packages/masterdir/usr/aarch64-linux-gnu/usr/lib/python3.6/site-packages/bluetooth/bluez.py&quot;</span><span style="color:#e6e1dc;">, line 10, in </span><span style="color:#cc7833;">&lt;</span><span style="color:#e6e1dc;">module</span><span style="color:#cc7833;">&gt;
</span><span style="color:#e6e1dc;">    </span><span style="color:#e6e1dc;">import bluetooth._bluetooth as _bt
</span><span style="color:#e6e1dc;">ModuleNotFoundError: No module named </span><span style="color:#a5c261;">&#39;bluetooth._bluetooth&#39;
</span></pre>
<p>That is borked!, but do not despair, lets remove the <code>EXT_SUFFIX</code>.</p>
<pre style="background-color:#383838;">
<span style="color:#e6e1dc;">$ mv</span><span style="font-style:italic;color:#fd971f;"> -v</span><span style="color:#e6e1dc;"> usr/lib/python3.6/site-packages/bluetooth/_bluetooth{.cpython-36m-x86_64-linux-gnu,}.so
</span></pre>
<p>And let's try again!</p>
<pre style="background-color:#383838;">
<span style="color:#e6e1dc;">$ python3
</span><span style="color:#cc7833;">&gt;&gt;&gt;</span><span style="color:#e6e1dc;"> import bluetooth
</span><span style="color:#cc7833;">&gt;&gt;&gt;
</span></pre>
<p>Success! So our solution is simply to just remove the <code>EXT_SUFFIX</code> from all modules.</p>
<h2 id="solving">Solving</h2>
<p>For this <code>xbps-src</code> has a very nifty mechanism, <code>hooks</code>.</p>
<p>Hooks are files with the <code>sh</code> extension that provide a <code>hook()</code> function, depending
on where the file is located it will be run during a specific stage of the package
build process.</p>
<p>As an example: hooks in <code>common/hooks/post-install</code> will run after the <code>do_install()</code>
function is ran, these hooks are available for all major stages of building a package,
before (pre-&lt;stage&gt;) during (do-&lt;stage&gt;) and after (post-&lt;stage&gt;).</p>
<p>So let's just write a hook that does the renaming for us!</p>
<pre style="background-color:#383838;">
<span style="font-style:italic;color:#7c7865;"># This hook executes the following tasks:
</span><span style="font-style:italic;color:#7c7865;">#	- renames cpython binding files to not include the arch-specific extension suffix
</span><span style="color:#e6e1dc;">
</span><span style="color:#86c20e;">hook</span><span style="color:#e6e1dc;">() {
</span><span style="color:#e6e1dc;">    </span><span style="color:#cc7833;">if </span><span style="color:#da4939;">[ </span><span style="color:#cc7833;">! </span><span style="font-style:italic;color:#fd971f;">-d </span><span style="color:#e6e1dc;">${</span><span style="color:#d0d0ff;">PKGDESTDIR</span><span style="color:#e6e1dc;">}/${</span><span style="color:#d0d0ff;">py3_sitelib</span><span style="color:#e6e1dc;">} </span><span style="color:#da4939;">]</span><span style="color:#cc7833;">; then
</span><span style="color:#e6e1dc;">        </span><span style="color:#cc7833;">return</span><span style="color:#e6e1dc;"> 0
</span><span style="color:#e6e1dc;">    </span><span style="color:#cc7833;">fi
</span><span style="color:#e6e1dc;">
</span><span style="color:#e6e1dc;">    </span><span style="color:#e6e1dc;">find </span><span style="color:#c1be91;">&quot;${</span><span style="color:#d0d0ff;">PKGDESTDIR</span><span style="color:#c1be91;">}/${</span><span style="color:#d0d0ff;">py3_sitelib</span><span style="color:#c1be91;">}&quot;</span><span style="font-style:italic;color:#fd971f;"> -type</span><span style="color:#e6e1dc;"> f</span><span style="font-style:italic;color:#fd971f;"> -executable -iname </span><span style="color:#a5c261;">&#39;*.cpython*.so&#39; </span><span style="color:#e6e1dc;">\
</span><span style="color:#e6e1dc;">        </span><span style="color:#cc7833;">| while </span><span style="color:#da4939;">read </span><span style="font-style:italic;color:#fd971f;">-r</span><span style="color:#e6e1dc;"> file</span><span style="color:#cc7833;">; do
</span><span style="color:#e6e1dc;">        </span><span style="color:#d0d0ff;">filename</span><span style="color:#cc7833;">=</span><span style="color:#c1be91;">&quot;${</span><span style="color:#d0d0ff;">file</span><span style="color:#cc7833;">##*</span><span style="color:#c1be91;">/}&quot;
</span><span style="color:#e6e1dc;">        </span><span style="color:#d0d0ff;">modulename</span><span style="color:#cc7833;">=</span><span style="color:#c1be91;">&quot;${</span><span style="color:#d0d0ff;">filename</span><span style="color:#cc7833;">%%</span><span style="color:#c1be91;">.</span><span style="color:#cc7833;">*</span><span style="color:#c1be91;">}&quot;
</span><span style="color:#e6e1dc;">        </span><span style="color:#e6e1dc;">msg_warn </span><span style="color:#c1be91;">&quot;${</span><span style="color:#d0d0ff;">pkgver</span><span style="color:#c1be91;">}: renamed &#39;${</span><span style="color:#d0d0ff;">filename</span><span style="color:#c1be91;">}&#39; to &#39;${</span><span style="color:#d0d0ff;">modulename</span><span style="color:#c1be91;">}.so&#39;.\n&quot;
</span><span style="color:#e6e1dc;">        </span><span style="color:#e6e1dc;">mv ${</span><span style="color:#d0d0ff;">file</span><span style="color:#e6e1dc;">} ${</span><span style="color:#d0d0ff;">file</span><span style="color:#cc7833;">%</span><span style="color:#e6e1dc;">/</span><span style="color:#cc7833;">*</span><span style="color:#e6e1dc;">}/${</span><span style="color:#d0d0ff;">modulename</span><span style="color:#e6e1dc;">}.so
</span><span style="color:#e6e1dc;">    </span><span style="color:#cc7833;">done
</span><span style="color:#e6e1dc;">}
</span></pre>
<p>Heh, looks good enough to me. Improvements can be made with a pull request to <a href="https://github.com/void-linux/void-packages">void-packages</a>.</p>
<p>Let's try building our package again!</p>
<pre style="background-color:#383838;">
<span style="color:#e6e1dc;">$ xbps-src</span><span style="font-style:italic;color:#fd971f;"> -a</span><span style="color:#e6e1dc;"> aarch64 pkg python-yaml
</span><span style="color:#cc7833;">=&gt;</span><span style="color:#e6e1dc;"> WARNING: python3-yaml-3.13_2: renamed </span><span style="color:#a5c261;">&#39;_yaml.cpython-36m-x86_64-linux-gnu.so&#39;</span><span style="color:#e6e1dc;"> to </span><span style="color:#a5c261;">&#39;_yaml.so&#39;</span><span style="color:#e6e1dc;">.
</span><span style="color:#e6e1dc;">$ env XBPS_TARGET_ARCH=aarch64 xls python3-yaml </span><span style="color:#cc7833;">| </span><span style="color:#e6e1dc;">grep </span><span style="color:#a5c261;">&#39;.so$&#39;
</span><span style="color:#e6e1dc;">/usr/lib/python3.6/site-packages/_yaml.so
</span></pre>
<p>Nice! Our work here is done. Meet me up in pt. 2 for a similar story around another problem.</p>

    </div>

    
    

    <div class="post-footer">
        
            
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;maxice8.github.io&#x2F;even.js" ></script>
      
    </body>

</html>
